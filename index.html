<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precursor Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 font-sans">
    
    <script>
import React, { useState } from 'react';
import Papa from 'papaparse';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Upload, Activity, AlertCircle } from 'lucide-react';

const CONVERSIONS = {
  'Tobacco': 1333.33,      // sticks per kg
  'Acetate tow': 8333.33,  // sticks per kg
  'Cigarette paper': 20000, // sticks per kg
  'Filter rods': 6,        // sticks per rod (Piece)
  'UNITS': {
    'MIL': 1000,
    'KGM': 1000,
    'BOX/BAG/PACK': 20,
    'PIECE': 1,
    'лелб': 1,
    'CASE': 10000
  }
};

export default function PrecursorMonitor() {
  const [sheetUrl, setSheetUrl] = useState('');
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);

  const processData = (rawRows) => {
    const summary = {};

    rawRows.forEach(row => {
      const entity = row.Importer || row.Exporter;
      const material = row.Material;
      const qty = parseFloat(row.Quantity) || 0;
      const unit = (row['Quantity Unit'] || '').toUpperCase();

      if (!entity) return;
      if (!summary[entity]) summary[entity] = { name: entity, potential: 0, actual: 0 };

      if (material === 'Cigarettes') {
        const factor = CONVERSIONS.UNITS[unit] || 1;
        summary[entity].actual += qty * factor;
      } else {
        const factor = CONVERSIONS[material] || 0;
        summary[entity].potential += qty * factor;
      }
    });

    return Object.values(summary)
      .map(item => ({
        ...item,
        gap: item.potential - item.actual,
        ratio: item.actual > 0 ? (item.potential / item.actual).toFixed(2) : 'N/A'
      }))
      .sort((a, b) => b.potential - a.potential);
  };

  const handleFetch = async () => {
    setLoading(true);
    // Convert regular Google Sheet URL to CSV export URL
    const csvUrl = sheetUrl.replace(/\/edit.*$/, '/export?format=csv');
    
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: (results) => {
        const processed = processData(results.data);
        setData(processed);
        setLoading(false);
      }
    });
  };

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 p-8 font-sans">
      {/* Header */}
      <div className="max-w-6xl mx-auto mb-10">
        <h1 className="text-3xl font-bold text-blue-400 mb-2 flex items-center gap-2">
          <Activity size={32} /> Cigarette Precursor Monitor
        </h1>
        <p className="text-slate-400">Entity-Ranking Dashboard & Production Discrepancy Analysis</p>
      </div>

      {/* Input Section */}
      <div className="max-w-6xl mx-auto bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-xl mb-8">
        <div className="flex gap-4">
          <input 
            type="text" 
            placeholder="Paste Google Sheet Public Link..." 
            className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
            value={sheetUrl}
            onChange={(e) => setSheetUrl(e.target.value)}
          />
          <button 
            onClick={handleFetch}
            className="bg-blue-600 hover:bg-blue-500 transition px-6 py-2 rounded-lg font-semibold flex items-center gap-2"
          >
            {loading ? 'Processing...' : <><Upload size={20} /> Sync Data</>}
          </button>
        </div>
      </div>

      {data.length > 0 && (
        <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Chart Section */}
          <div className="lg:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700 h-96">
            <h2 className="text-lg font-semibold mb-4 text-slate-300">Potential vs. Actual Sticks (by Entity)</h2>
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={data.slice(0, 10)}>
                <XAxis dataKey="name" hide />
                <YAxis />
                <Tooltip contentStyle={{backgroundColor: '#1e293b', border: 'none'}} />
                <Bar dataKey="potential" fill="#3b82f6" name="Potential Sticks" />
                <Bar dataKey="actual" fill="#10b981" name="Actual Exported" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Ranking List */}
          <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 overflow-y-auto max-h-96">
            <h2 className="text-lg font-semibold mb-4 text-slate-300 flex items-center gap-2">
               <AlertCircle size={18} className="text-yellow-500" /> High-Risk Rankings
            </h2>
            {data.map((item, idx) => (
              <div key={idx} className="mb-4 pb-4 border-b border-slate-700 last:border-0">
                <div className="flex justify-between text-sm mb-1">
                  <span className="font-medium text-blue-300 truncate w-32">{item.name}</span>
                  <span className="text-slate-500">{Math.round(item.gap).toLocaleString()} sticks gap</span>
                </div>
                <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                  <div 
                    className="bg-blue-500 h-full" 
                    style={{width: `${Math.min((item.actual/item.potential)*100, 100)}%`}} 
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
    </script>
</body>
</html>
